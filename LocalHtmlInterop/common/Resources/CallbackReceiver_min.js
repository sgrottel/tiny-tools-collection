class CallbackReceiver{#a;#b;#c;#d;#e;#f;#g;constructor(e,s){this.#a=e,this.#d="",this.#e=0,this.#f=!1,this.#g=null,this.#c=new WebSocket(`ws://127.0.0.1:${s}/`),this.#c.onopen=e=>{let s=this;this.#b=setTimeout(function(){s.#h()},1e3)},this.#c.onclose=e=>{this.close()},this.#c.onerror=e=>{this.#i?this.#j():this.#i({status:"error",output:e.data}),this.close()},this.#c.onmessage=e=>{if(e.data&&("string"==typeof e.data||e.data instanceof String)&&e.data.length>0){if(this.#d+=e.data,this.#j(),this.#f)this.close();else{let s=this;this.#b=setTimeout(function(){s.#h()},1e3)}}else null===e.data||(this.#d&&this.#j(),this.#i({status:"error",output:`Unexpected (${ex}) non-json data received: ${e.data}`})),this.close()}}close(){if(0!==this.#b&&(clearTimeout(this.#b),this.#b=0),null!==this.#c){let e=this.#c;this.#c=null,e.close()}this.#d&&(this.#j(),this.#d&&this.#i({status:"error",output:`Unprocessable data received: ${this.#d}`})),0===this.#e?this.#i({status:"error",output:"No data received"}):this.#f||this.#i({status:"error",output:"No final data message received"})}#h(){this.#c&&this.#c.send(`reqCallback:${this.#a}`)}#i(e){e&&this.#g&&this.#g(e)}setOnResultCallback(e){this.#g=e,this.#g&&this.#d&&this.#j()}#j(){let s=0,t=0,r=!1,n=!1,i=0;for(let a=0;a<this.#d.length;++a){switch(this.#d[a]){case"{":!r&&(0===i&&(s=a),i++);break;case"}":if(!r&&(i>0&&i--,0===i)){t=a;let o=this.#d.substring(s,t+1);try{let l=JSON.parse(o);this.#g&&(this.#e++,this.#i(l)),l.status&&"unknown"!==l.status&&"pending"!==l.status&&(this.#f=!0)}catch(u){this.#i({status:"error",output:`Unexpected (${u}) parsing received data: (${s}..${t}) ${o}`})}}break;case'"':n||(r=!r)}n=r&&"\\"===this.#d[a]}this.#g&&(this.#d=this.#d.substring(t+1))}}
